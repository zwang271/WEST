# This script runs WEST on a directory of formulas generated by gen_formulas.py
# The name of the directory is the parameter of interest
# Each file in the directory contains 250 formulas for a given value of the parameter
# The name of the file is the value of the parameter
# The results for each file is written to a file called {value}.result in the same directory
# The results file contains the formula, the time it took to run WEST on the formula, and the length of the output
# If any formula takes longer than 120 seconds to run, the output length is set to -1 and the time is set to 120
# Usage: python3 benchmark.py <directory>

import sys
import subprocess
import signal
import time
from random_mltl_formulas import generate_random_formula
from tqdm import tqdm
import os
import argparse

def run_west(formula: str, timelimit: int = 120):
    start = time.perf_counter()
    formula = formula.replace("a", "p")
    # check if system is Windows or Linux
    if sys.platform == "win32":
        west_exec = "west.exe"
    else:
        west_exec = "./west" 
    cmd = f"cd ../../src && {west_exec} \"{formula}\""
    pro = subprocess.Popen(cmd, 
                           shell=True, 
                           stdout=subprocess.DEVNULL,
                           stderr=subprocess.DEVNULL,
                           preexec_fn=os.setsid)
    try:
        pro.wait(timelimit)
    except subprocess.TimeoutExpired:
        os.killpg(os.getpgid(pro.pid), signal.SIGTERM)
        return timelimit
    return time.perf_counter() - start

def runall(formulas: list[str], timelimit: int = 120):
    times = []
    output_lengths = []
    for formula in tqdm(formulas):
        duration = run_west(formula, timelimit)
        times.append(duration)
        with open("../../src/output/output.txt", "r") as f:
            # skip first line
            output_lengths.append(len(f.readlines()) - 1)
    return times, output_lengths

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Benchmark WEST")
    parser.add_argument("-dir", help="Directory containing .txt files")
    parser.add_argument("-timelimit", default=120,
                        help="Time limit for each formula", type=int)
    args = parser.parse_args()
    dir = args.dir
    timelimit = args.timelimit
    for file in os.listdir(dir):
        if file.endswith(".txt"):
            print(f"Running WEST on {file}")
            with open(os.path.join(dir, file), "r") as f:
                formulas = f.readlines()
            formulas = [formula.strip() for formula in formulas]
            file = file.replace(".txt", "")
            times, output_lengths = runall(formulas, timelimit)
            with open(os.path.join(dir, f"{file}.result"), "w") as f:
                for i in range(len(formulas)):
                    f.write(f"{formulas[i]} : {times[i]} : {output_lengths[i]}\n")